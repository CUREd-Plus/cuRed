---
# Outpatient (OP) data validation rules

rules:
# ðŸ”‘ ATTENDKEY HES Record Identifier (primary key)
- name: ATTENDKEY is required
  expr: '!is.na(ATTENDKEY)'
  meta:
    severity: error
  
- name: ATTENDKEY is unique
  expr: is_unique(ATTENDKEY)
  meta:
    severity: error

- name: ATTENDKEY 12n 
  description: ATTENDKEY has 12 integers (2003-04 to 2020-21)
  expr: grepl("^\\d{12}$", ATTENDKEY)

- name: ATTENDKEY 19n
  description: ATTENDKEY has 19 integers (2021-22 onwards)
  expr: grepl("^\\d{19}$", ATTENDKEY)

# TOKEN_PERSON_ID
- name: TOKEN_PERSON_ID is required
  expr: '!is.na(TOKEN_PERSON_ID)'
  meta:
    severity: error
    
- name: TOKEN_PERSON_ID 32an
  description: TOKEN_PERSON_ID is alphanumeric with length 32
  expr: grepl("^[a-zA-Z0-9]{32}$", TOKEN_PERSON_ID)
  meta:
    severity: error

# LSOA01 Lower Super Output Area of Residence 2001
- name: LSOA01 9an
  description: LSOA01 Alphanumeric length 9
  expr: grepl("^[A-Z0-9]{9}$", LSOA01)

# LSOA11 Lower Super Output Area of Residence 2011
- name: LSOA11 9an
  description: LSOA11 Alphanumeric length 9.
  expr: grepl("^[A-Z0-9]{9}$", LSOA11)
  
# APPTDATE Appointment Date
- name: APPTDATE is date
  description: Date(YYYY-MM-DD)
  expr: grepl("^\\d{4}-([0]\\d|1[0-2])-([0-2]\\d|3[01])$", APPTDATE)
  meta:
    severity: error

# APPTAGE_CALC Age on date of appointment (babies decimalised)
- name: APPTAGE_CALC unsigned decimal
  description: Positive float
  expr: is.numeric(APPTAGE_CALC) & APPTAGE_CALC >= 0

# STUDY_ID person cohort identifier
- name: STUDY_ID is required
  expr: '!is.na(STUDY_ID)'
  meta:
    severity: error
...
