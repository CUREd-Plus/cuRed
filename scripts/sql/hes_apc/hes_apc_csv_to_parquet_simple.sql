/*
Convert CSV files to Parquet files.
*/

-- Configure DuckDB
-- https://duckdb.org/docs/archive/0.5.1/sql/configuration.html
SET temp_directory = '/tmp';

-- Read CSV files
COPY (
  SELECT *
  FROM read_csv('{path}',
    delim='|', header=TRUE,
    -- Columns must be ordered
    columns={'ACSCFLAG': 'UBIGINT', 'ACTIVAGE': 'UBIGINT', 'ADMIAGE': 'UBIGINT', 'ADMIDATE': 'DATE', 'ADMIMETH': 'VARCHAR', 'ADMINCAT': 'VARCHAR', 'ADMISORC': 'VARCHAR', 'ADMISTAT': 'VARCHAR', 'AEKEY': 'VARCHAR', 'ALCBRDDIAG': 'VARCHAR', 'ALCBRDFRAC': 'VARCHAR', 'ALCDIAG': 'VARCHAR', 'ALCDIAG_4': 'VARCHAR', 'ALCFRAC': 'VARCHAR', 'ALCNRWDIAG': 'VARCHAR', 'ALCNRWFRAC': 'VARCHAR', 'AT_GP_PRACTICE': 'VARCHAR', 'AT_RESIDENCE': 'VARCHAR', 'AT_TREATMENT': 'VARCHAR', 'BEDYEAR': 'UBIGINT', 'CANNET': 'VARCHAR', 'CANREG': 'VARCHAR', 'CARERSI': 'VARCHAR', 'CAUSE': 'VARCHAR', 'CAUSE_3': 'VARCHAR', 'CAUSE_4': 'VARCHAR', 'CCG_GP_PRACTICE': 'VARCHAR', 'CCG_RESIDENCE': 'VARCHAR', 'CCG_TREATMENT': 'VARCHAR', 'CENDUR': 'UBIGINT', 'CENSAGE': 'UBIGINT', 'CENSTAT': 'VARCHAR', 'CENWARD': 'VARCHAR', 'CLASSPAT': 'VARCHAR', 'CURRWARD_ONS': 'VARCHAR', 'DETDUR': 'UBIGINT', 'DETNCAT': 'VARCHAR', 'DETNDATE': 'DATE', 'DIAG_01': 'VARCHAR', 'DIAG_02': 'VARCHAR', 'DIAG_03': 'VARCHAR', 'DIAG_04': 'VARCHAR', 'DIAG_05': 'VARCHAR', 'DIAG_06': 'VARCHAR', 'DIAG_07': 'VARCHAR', 'DIAG_08': 'VARCHAR', 'DIAG_09': 'VARCHAR', 'DIAG_10': 'VARCHAR', 'DIAG_11': 'VARCHAR', 'DIAG_12': 'VARCHAR', 'DIAG_13': 'VARCHAR', 'DIAG_14': 'VARCHAR', 'DIAG_15': 'VARCHAR', 'DIAG_16': 'VARCHAR', 'DIAG_17': 'VARCHAR', 'DIAG_18': 'VARCHAR', 'DIAG_19': 'VARCHAR', 'DIAG_20': 'VARCHAR', 'Diag_3_01': 'VARCHAR', 'DIAG_3_02': 'VARCHAR', 'DIAG_3_03': 'VARCHAR', 'DIAG_3_04': 'VARCHAR', 'DIAG_3_05': 'VARCHAR', 'DIAG_3_06': 'VARCHAR', 'DIAG_3_07': 'VARCHAR', 'DIAG_3_08': 'VARCHAR', 'DIAG_3_09': 'VARCHAR', 'DIAG_3_10': 'VARCHAR', 'DIAG_3_11': 'VARCHAR', 'DIAG_3_12': 'VARCHAR', 'DIAG_3_CONCAT': 'VARCHAR', 'Diag_4_01': 'VARCHAR', 'DIAG_4_02': 'VARCHAR', 'DIAG_4_03': 'VARCHAR', 'DIAG_4_04': 'VARCHAR', 'DIAG_4_05': 'VARCHAR', 'DIAG_4_06': 'VARCHAR', 'DIAG_4_07': 'VARCHAR', 'DIAG_4_08': 'VARCHAR', 'DIAG_4_09': 'VARCHAR', 'DIAG_4_10': 'VARCHAR', 'DIAG_4_11': 'VARCHAR', 'DIAG_4_12': 'VARCHAR', 'DIAG_4_CONCAT': 'VARCHAR', 'DIAG_COUNT': 'UBIGINT', 'DISDATE': 'DATE', 'DISDEST': 'VARCHAR', 'DISMETH': 'VARCHAR', 'DISREADYDATE': 'DATE', 'DOMPROC': 'VARCHAR', 'ELECDATE': 'DATE', 'ELECDUR': 'UBIGINT', 'ELECDUR_CALC': 'UBIGINT', 'ENDAGE': 'UBIGINT', 'EPIDUR': 'UBIGINT', 'EPIEND': 'DATE', 'EPIKEY': 'VARCHAR', 'EPIORDER': 'UBIGINT', 'EPISTART': 'DATE', 'EPISTAT': 'UBIGINT', 'EPITYPE': 'UBIGINT', 'ETHNOS': 'VARCHAR', 'ETHRAW': 'VARCHAR', 'FAE': 'UBIGINT', 'FAE_EMERGENCY': 'UBIGINT', 'FCE': 'UBIGINT', 'FIRSTREG': 'VARCHAR', 'FYEAR': 'VARCHAR', 'GORTREAT': 'VARCHAR', 'GPPRAC': 'VARCHAR', 'HRGLATE35': 'VARCHAR', 'HRGNHS': 'VARCHAR', 'HRGNHSVN': 'VARCHAR', 'INTMANIG': 'VARCHAR', 'LEGALGPA': 'VARCHAR', 'LEGALGPC': 'VARCHAR', 'LEGLCAT': 'VARCHAR', 'LEGLSTAT': 'VARCHAR', 'LSOA01': 'VARCHAR', 'LSOA11': 'VARCHAR', 'MAINSPEF': 'VARCHAR', 'MARSTAT': 'VARCHAR', 'MENTCAT': 'VARCHAR', 'MSOA01': 'VARCHAR', 'MSOA11': 'VARCHAR', 'MYDOB': 'VARCHAR', 'NEWNHSNO_CHECK': 'VARCHAR', 'NHSNOIND': 'VARCHAR', 'OACODE11': 'VARCHAR', 'OPDATE_01': 'VARCHAR', 'OPDATE_02': 'VARCHAR', 'OPDATE_03': 'VARCHAR', 'OPDATE_04': 'VARCHAR', 'OPDATE_05': 'VARCHAR', 'OPDATE_06': 'VARCHAR', 'OPDATE_07': 'VARCHAR', 'OPDATE_08': 'VARCHAR', 'OPDATE_09': 'VARCHAR', 'OPDATE_10': 'VARCHAR', 'OPDATE_11': 'VARCHAR', 'OPDATE_12': 'VARCHAR', 'OPDATE_13': 'VARCHAR', 'OPDATE_14': 'VARCHAR', 'OPDATE_15': 'VARCHAR', 'OPDATE_16': 'VARCHAR', 'OPDATE_17': 'VARCHAR', 'OPDATE_18': 'VARCHAR', 'OPDATE_19': 'VARCHAR', 'OPDATE_20': 'VARCHAR', 'OPDATE_21': 'VARCHAR', 'OPDATE_22': 'VARCHAR', 'OPDATE_23': 'VARCHAR', 'OPDATE_24': 'VARCHAR', 'OPERSTAT': 'VARCHAR', 'OPERTN_01': 'VARCHAR', 'OPERTN_02': 'VARCHAR', 'OPERTN_03': 'VARCHAR', 'OPERTN_04': 'VARCHAR', 'OPERTN_05': 'VARCHAR', 'OPERTN_06': 'VARCHAR', 'OPERTN_07': 'VARCHAR', 'OPERTN_08': 'VARCHAR', 'OPERTN_09': 'VARCHAR', 'OPERTN_10': 'VARCHAR', 'OPERTN_11': 'VARCHAR', 'OPERTN_12': 'VARCHAR', 'OPERTN_13': 'VARCHAR', 'OPERTN_14': 'VARCHAR', 'OPERTN_15': 'VARCHAR', 'OPERTN_16': 'VARCHAR', 'OPERTN_17': 'VARCHAR', 'OPERTN_18': 'VARCHAR', 'OPERTN_19': 'VARCHAR', 'OPERTN_20': 'VARCHAR', 'OPERTN_21': 'VARCHAR', 'OPERTN_22': 'VARCHAR', 'OPERTN_23': 'VARCHAR', 'OPERTN_24': 'VARCHAR', 'OPERTN_3_01': 'VARCHAR', 'OPERTN_3_02': 'VARCHAR', 'OPERTN_3_03': 'VARCHAR', 'OPERTN_3_04': 'VARCHAR', 'OPERTN_3_05': 'VARCHAR', 'OPERTN_3_06': 'VARCHAR', 'OPERTN_3_07': 'VARCHAR', 'OPERTN_3_08': 'VARCHAR', 'OPERTN_3_09': 'VARCHAR', 'OPERTN_3_10': 'VARCHAR', 'OPERTN_3_11': 'VARCHAR', 'OPERTN_3_12': 'VARCHAR', 'OPERTN_3_13': 'VARCHAR', 'OPERTN_3_14': 'VARCHAR', 'OPERTN_3_15': 'VARCHAR', 'OPERTN_3_16': 'VARCHAR', 'OPERTN_3_17': 'VARCHAR', 'OPERTN_3_18': 'VARCHAR', 'OPERTN_3_19': 'VARCHAR', 'OPERTN_3_20': 'VARCHAR', 'OPERTN_3_21': 'VARCHAR', 'OPERTN_3_22': 'VARCHAR', 'OPERTN_3_23': 'VARCHAR', 'OPERTN_3_24': 'VARCHAR', 'OPERTN_3_CONCAT': 'VARCHAR', 'OPERTN_4_01': 'VARCHAR', 'OPERTN_4_02': 'VARCHAR', 'OPERTN_4_03': 'VARCHAR', 'OPERTN_4_04': 'VARCHAR', 'OPERTN_4_05': 'VARCHAR', 'OPERTN_4_06': 'VARCHAR', 'OPERTN_4_07': 'VARCHAR', 'OPERTN_4_08': 'VARCHAR', 'OPERTN_4_09': 'VARCHAR', 'OPERTN_4_10': 'VARCHAR', 'OPERTN_4_11': 'VARCHAR', 'OPERTN_4_12': 'VARCHAR', 'OPERTN_4_13': 'VARCHAR', 'OPERTN_4_14': 'VARCHAR', 'OPERTN_4_15': 'VARCHAR', 'OPERTN_4_16': 'VARCHAR', 'OPERTN_4_17': 'VARCHAR', 'OPERTN_4_18': 'VARCHAR', 'OPERTN_4_19': 'VARCHAR', 'OPERTN_4_20': 'VARCHAR', 'OPERTN_4_21': 'VARCHAR', 'OPERTN_4_22': 'VARCHAR', 'OPERTN_4_23': 'VARCHAR', 'OPERTN_4_24': 'VARCHAR', 'OPERTN_4_CONCAT': 'VARCHAR', 'OPERTN_COUNT': 'UBIGINT', 'ORGPPPID': 'VARCHAR', 'PCONSULT': 'VARCHAR', 'POSOPDUR': 'UBIGINT', 'PREOPDUR': 'UBIGINT', 'PROCODE': 'VARCHAR', 'PROCODE3': 'VARCHAR', 'PROCODE5': 'VARCHAR', 'PROCODET': 'VARCHAR', 'PROTYPE': 'VARCHAR', 'PROVSPNOPS': 'VARCHAR', 'REFERORG': 'VARCHAR', 'RESLADST_ONS': 'VARCHAR', 'RTTPEREND': 'DATE', 'RTTPERSTART': 'DATE', 'RTTPERSTAT': 'VARCHAR', 'RURURB_IND': 'VARCHAR', 'SENDER': 'VARCHAR', 'SEX': 'VARCHAR', 'SITETRET': 'VARCHAR', 'SPELBGIN': 'UBIGINT', 'SPELDUR': 'UBIGINT', 'SPELEND': 'VARCHAR', 'STARTAGE': 'UBIGINT', 'STARTAGE_CALC': 'DOUBLE', 'SUSCOREHRG': 'VARCHAR', 'SUSHRG': 'VARCHAR', 'SUSHRGVERS': 'VARCHAR', 'SUSLDDATE': 'DATE', 'SUSRECID': 'UBIGINT', 'SUSSPELLID': 'VARCHAR', 'Token_Person_ID': 'VARCHAR', 'TRETSPEF': 'VARCHAR', 'VIND': 'VARCHAR', 'WAITDAYS': 'UBIGINT', 'WAITLIST': 'UBIGINT', 'WARDSTRT': 'VARCHAR'}
  )
)

/*
Write Parquet
*/
TO '{path}.parquet'
-- https://duckdb.org/docs/sql/statements/copy.html#parquet-options
WITH (
   FORMAT 'PARQUET'
  ,COMPRESSION 'snappy'
  ,ROW_GROUP_SIZE 122880
);
